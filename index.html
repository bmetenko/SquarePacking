<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>PyScript Square Packing</title>

    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />

    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <style>
      button {
        color: black;
        background-color: lightblue;
        padding: 5px;
        margin: 5px;
        border-radius: 5px;
      }
      input {
        margin: 5px;
        border-color: aliceblue;
        border: 2px;
        border-style: solid;
        padding: 2px;
      }
      input[type=number] {text-align: right;}
      #controls {
        background-color: rgb(178, 248, 238);
        display: flex;
        justify-content: center;
        opacity: 50%;
      }
      #controls:hover, #controls:active, #controls:focus {
        opacity: 100%;
      }

      label {
        align-self: center;
      }
      #message-container{
        display: flex; 
        justify-content: center; 
        height: 2em; 
        // border: 2px black; 
        // border-style: dashed;
        align-items: center;
        margin: 5px;
      }
      #messages {
        background: transparent;
        box-shadow: 3px 3px 7px 0 rgba(0, 0, 0, 0.2),
            -4px -4px 9px 0 rgba(255, 255, 255, 0.55);
        border-radius: 20px;
        padding: 2px 15px 10px;
      }
    </style>

    <script type='text/javascript'>
      function plot(graph, chart) {
          var figure = JSON.parse(graph)
          var layout = {
            autosize: true
          };

          Plotly.newPlot(chart, figure, layout);

          function resP(id){
            var d3 = Plotly.d3;

            var parent_width = document.getElementById("chart1").parentElement.clientWidth
            var parent_height = document.getElementById("chart1").parentElement.clientHeight
            var gd3 = d3.select(document.getElementById(id))
              .style({
              width: parent_width - 10,
              height: parent_height - 10
              });
            return gd3.node();
          }

          window.addEventListener('resize', function(){
            Plotly.Plots.resize( resP(chart) );
          })

      }
      
    </script>

  </head>

  <body>

<py-env>
  - pandas
  - numpy
  - plotly
  - paths:
      - ./squares.py
</py-env>

<div id="controls">
  <button id="reset-canvas" style="background-color: pink;">
    Reset Canvas
  </button>
  <label>
    Canvas Size:
  </label>
  <input id="canvas-size" value="9" type="number" min="5", max="100">
  </input>

  <button id="canvas-size-update" type="button">
    Update Canvas Size
  </button>

  <label>
    Width:
  </label>
  <input id="width" value="1" type="number" min="1", max="10">
  </input>

  <label>
    Length:
  </label>
  <input id="length" value="1" type="number" min="1", max="10">
  </input>

  <button id="add-rect" type="button">
    Add Rectangle
  </button>

</div>

<div id="message-container">
  <div id="messages" style="padding: 5px;">
Welcome! Please modify bounds or reset to add rectangles.
  </div>
</div>

<div id="chart-row" style="display: flex; justify-content: center;">
  <div id="chart-container" style="width: 75%; height: 75%;">
    <div id="chart1" style="width: 100%; height: 100%;"></div>
  </div>
</div>

<py-script>
import js
import json
import pandas as pd
import numpy as np
import plotly
import plotly.graph_objects as go
import plotly.io as pio
from pyodide import create_proxy

from squares import Rect, Square, SquareCanvas, check_bounds

list_square_radii_1 = [3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1]
list_squares_1 = [Square(radius) for radius in list_square_radii_1]

B = SquareCanvas(max_bound=8, contents=list_squares_1)

fig = B.generate_plotly(render="object")

graphJSON = json.dumps(
  fig, 
  cls=plotly.utils.PlotlyJSONEncoder
)

js.plot(graphJSON,"chart1")

sess = js.sessionStorage

sess.setItem('chart1', graphJSON)
sess.setItem('chart-data', B.contents)

canvas_size = js.document.getElementById("canvas-size")
reset_button = js.document.getElementById("reset-canvas")

def reset_chart(a):
    B = SquareCanvas(max_bound=int(canvas_size.value), contents=[])

    fig = B.generate_plotly(render="object")

    graphJSON = json.dumps(
        fig, 
        cls=plotly.utils.PlotlyJSONEncoder
    )

    js.plot(graphJSON,"chart1")

    js.document.getElementById("messages").innerText = "Canvas reset."

    sess.setItem('chart1', graphJSON)
    sess.setItem('chart-data', B.contents)

reset_button.addEventListener("click", create_proxy(reset_chart))

def update_chart_size(a):    
    contents = sess.getItem('chart-data')[1:-1]

    B = SquareCanvas(max_bound=int(canvas_size.value))

    for sq_def in contents.split("],"):
        import re
        text = sq_def.split("::")[0]
        text = text.replace("[", "").replace("]", "").replace(" ", "")
        split_text = re.split(r'(?=\d)', text, 1)


        if split_text[0] == "Square":
            try:
                B.add_contents(Square(side=int(split_text[1])))
            
            except IndexError:
                js.document.getElementById("messages").innerText = "Couldn't place all..."
                return

        if split_text[0] == "Rect":
            try:
                lw = text.split("Rect")[1]
                split_lw = lw.split("x")
                B.add_contents(Rect(length=int(split_lw[0]), width=int(split_lw[1])))

            except IndexError:
                js.document.getElementById("messages").innerText = "Couldn't place all..."
                return

    fig = B.generate_plotly(render="object")

    graphJSON = json.dumps(
        fig, 
        cls=plotly.utils.PlotlyJSONEncoder
    )

    js.plot(graphJSON,"chart1")
    
    sess.setItem('chart1', graphJSON)
    sess.setItem('chart-data', B.contents)

    js.document.getElementById("messages").innerText = "Canvas updated."

canvas_update = js.document.getElementById("canvas-size-update")
canvas_update.addEventListener("click", create_proxy(update_chart_size))

width = js.document.getElementById("width")
length = js.document.getElementById("length")

add_rect = js.document.getElementById("add-rect")

def add_rectangle(a):
    contents = sess.getItem('chart-data')[1:-1]

    B = SquareCanvas(max_bound=int(canvas_size.value))

    for sq_def in contents.split("],"):
        import re
        text = sq_def.split("::")[0]
        text = text.replace("[", "").replace("]", "").replace(" ", "")
        split_text = re.split(r'(?=\d)', text, 1)


        if split_text[0] == "Square":
            try:
                B.add_contents(Square(side=int(split_text[1])))
            
            except IndexError:
                js.document.getElementById("messages").innerText = "Couldn't place all..."
                return

        if split_text[0] == "Rect":
            try:
                lw = text.split("Rect")[1]
                split_lw = lw.split("x")
                B.add_contents(Rect(length=int(split_lw[0]), width=int(split_lw[1])))

            except IndexError:
                js.document.getElementById("messages").innerText = "Couldn't place all..."
                return

    try:
        B.add_contents(Rect(length=int(length.value), width=int(width.value)))
    
    except IndexError:
        js.document.getElementById("messages").innerText = "Couldn't add rectangle..."
        return

    fig = B.generate_plotly(render="object")

    graphJSON = json.dumps(
        fig, 
        cls=plotly.utils.PlotlyJSONEncoder
    )

    js.plot(graphJSON,"chart1")
    
    sess.setItem('chart1', graphJSON)
    sess.setItem('chart-data', B.contents)

    js.document.getElementById("messages").innerText = "Canvas updated."


add_rect.addEventListener("click", create_proxy(add_rectangle))


    </py-script>

  </body>
</html>